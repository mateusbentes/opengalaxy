name: Multi-Platform Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Linux builds - x86_64 native
  linux-x86_64-build:
    name: Linux - x86_64
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON

      - name: Build
        run: |
          cd build
          ninja -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64-build
          path: build/
          retention-days: 7

  # Linux builds - ARM64 native (using GitHub's free ARM runners)
  linux-arm64-build:
    name: Linux - arm64
    runs-on: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON

      - name: Build
        run: |
          cd build
          ninja -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64-build
          path: build/
          retention-days: 7

  # macOS builds - Apple Silicon
  macos-build:
    name: macOS - arm64
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja qt@6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64

      - name: Build
        run: |
          cd build
          ninja -j$(sysctl -n hw.ncpu)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: build/
          retention-days: 7

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [linux-x86_64-build, linux-arm64-build, macos-build]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux Builds" >> $GITHUB_STEP_SUMMARY
          echo "- x86_64: ${{ needs.linux-x86_64-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.linux-arm64-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS Builds" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.macos-build.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any build failed
        if: |
          needs.linux-x86_64-build.result == 'failure' ||
          needs.linux-arm64-build.result == 'failure' ||
          needs.macos-build.result == 'failure'
        run: exit 1
