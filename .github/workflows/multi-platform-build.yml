name: Multi-Platform Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Linux builds with multiple architectures
  linux-build:
    name: Linux - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64, riscv64]
        include:
          - arch: x86_64
            cmake_args: ""
            qemu: false
            container: null
          - arch: arm64
            cmake_args: "-DCMAKE_SYSTEM_PROCESSOR=aarch64"
            qemu: true
            container: "arm64v8/ubuntu:24.04"
          - arch: riscv64
            cmake_args: "-DCMAKE_SYSTEM_PROCESSOR=riscv64"
            qemu: true
            container: "riscv64/ubuntu:24.04"

    container: ${{ matrix.container }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ${{ matrix.arch }}
        if: matrix.qemu && matrix.arch != 'x86_64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch }}

      - name: Install dependencies (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Install dependencies (arm64)
        if: matrix.arch == 'arm64'
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Install dependencies (riscv64)
        if: matrix.arch == 'riscv64'
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON \
            ${{ matrix.cmake_args }}

      - name: Build
        run: |
          cd build
          ninja -j$(nproc)

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-build
          path: build/
          retention-days: 7

  # macOS builds - Apple Silicon only
  macos-build:
    name: macOS - arm64
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja qt@6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64

      - name: Build
        run: |
          cd build
          ninja -j$(sysctl -n hw.ncpu)

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: build/
          retention-days: 7

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [linux-build, macos-build]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux Builds" >> $GITHUB_STEP_SUMMARY
          echo "- x86_64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- riscv64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS Builds" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.macos-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any build failed
        if: |
          needs.linux-build.result == 'failure' ||
          needs.macos-build.result == 'failure'
        run: exit 1
