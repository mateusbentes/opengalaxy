name: Multi-Platform Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Linux builds with multiple architectures
  linux-build:
    name: Linux - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, arm64, riscv64]
        include:
          - arch: x86_64
            cmake_args: ""
            qemu: false
          - arch: arm64
            cmake_args: "-DCMAKE_SYSTEM_PROCESSOR=aarch64"
            qemu: true
          - arch: riscv64
            cmake_args: "-DCMAKE_SYSTEM_PROCESSOR=riscv64"
            qemu: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ${{ matrix.arch }}
        if: matrix.qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch }}

      - name: Install dependencies (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-tools-dev \
            libqt6core6 \
            libqt6gui6 \
            libqt6network6 \
            libqt6sql6 \
            libqt6widgets6

      - name: Install cross-compilation dependencies (arm64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            crossbuild-essential-arm64 \
            pkg-config-aarch64-linux-gnu

      - name: Install Qt6 for arm64 from source
        if: matrix.arch == 'arm64'
        run: |
          mkdir -p /tmp/qt6-arm64
          cd /tmp/qt6-arm64
          # Download Qt6 prebuilt binaries for arm64 or use system packages
          # For now, we'll use a minimal approach with available packages
          sudo apt-get install -y \
            libgl1-mesa-dev:arm64 \
            libxkbcommon-dev:arm64 \
            libxkbcommon-x11-dev:arm64 \
            libfontconfig1-dev:arm64 \
            libfreetype6-dev:arm64 \
            libharfbuzz-dev:arm64 || true

      - name: Install cross-compilation dependencies (riscv64)
        if: matrix.arch == 'riscv64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            crossbuild-essential-riscv64 \
            pkg-config-riscv64-linux-gnu

      - name: Install Qt6 for riscv64 from source
        if: matrix.arch == 'riscv64'
        run: |
          mkdir -p /tmp/qt6-riscv64
          cd /tmp/qt6-riscv64
          # Download Qt6 prebuilt binaries for riscv64 or use system packages
          # For now, we'll use a minimal approach with available packages
          sudo apt-get install -y \
            libgl1-mesa-dev:riscv64 \
            libxkbcommon-dev:riscv64 \
            libxkbcommon-x11-dev:riscv64 \
            libfontconfig1-dev:riscv64 \
            libfreetype6-dev:riscv64 \
            libharfbuzz-dev:riscv64 || true

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake (x86_64)
        if: matrix.arch == 'x86_64'
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON

      - name: Configure CMake (arm64)
        if: matrix.arch == 'arm64'
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=OFF \
            -DBUILD_CLI=ON \
            -DBUILD_UI=OFF \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/aarch64-linux-gnu

      - name: Configure CMake (riscv64)
        if: matrix.arch == 'riscv64'
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=OFF \
            -DBUILD_CLI=ON \
            -DBUILD_UI=OFF \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=riscv64 \
            -DCMAKE_C_COMPILER=riscv64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=riscv64-linux-gnu-g++ \
            -DCMAKE_FIND_ROOT_PATH=/usr/riscv64-linux-gnu

      - name: Build
        run: |
          cd build
          ninja -j$(nproc)

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-build
          path: build/
          retention-days: 7

  # macOS builds - Apple Silicon only
  macos-build:
    name: macOS - arm64
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja qt@6

      - name: Create build directory
        run: mkdir -p build

      - name: Configure CMake
        run: |
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=ON \
            -DBUILD_CLI=ON \
            -DBUILD_UI=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64

      - name: Build
        run: |
          cd build
          ninja -j$(sysctl -n hw.ncpu)

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: build/
          retention-days: 7

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [linux-build, macos-build]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux Builds" >> $GITHUB_STEP_SUMMARY
          echo "- x86_64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- riscv64: ${{ needs.linux-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS Builds" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.macos-build.result || 'Completed' }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any build failed
        if: |
          needs.linux-build.result == 'failure' ||
          needs.macos-build.result == 'failure'
        run: exit 1
