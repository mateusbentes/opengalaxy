# Game Update Feature - Flow Diagram

## Update Detection Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Library Page Loads                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│           Fetch All Games from Library Service              │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Create Game Cards for Each Game                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
              ┌───────┴────────┐
              │  Is Installed? │
              └───────┬────────┘
                      │
            ┌─────────┴─────────┐
            │                   │
           YES                 NO
            │                   │
            ▼                   ▼
┌──────────────────────┐  ┌──────────────────┐
│  checkForUpdate()    │  │  Skip Update     │
│                      │  │  Check           │
└──────────┬───────────┘  └──────────────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────┐
│         Fetch Latest Downloads from GOG API                   │
└──────────┬───────────────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────┐
│         Compare Installed Version vs Latest Version           │
└──────────┬───────────────────────────────────────────────────┘
           │
           ▼
    ┌──────┴───────┐
    │  Different?  │
    └──────┬───────┘
           │
    ┌──────┴──────┐
    │             │
   YES           NO
    │             │
    ▼             ▼
┌─────────────┐  ┌──────────────┐
│ Show Update │  │ Hide Update  │
│ Button      │  │ Button       │
└─────────────┘  └──────────────┘
```

## Update Process Flow

```
┌─────────────────────────────────────────────────────────────┐
│              User Hovers Over Game Card                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│         Update Button Appears (if update available)          │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              User Clicks "⬆ UPDATE" Button                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  updateGame() Called                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Set Card State: updating = true                 │
│              Show Progress Bar (0%)                          │
│              Show Toast: "Updating game..."                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│         Fetch Latest Game Downloads from GOG                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    Call InstallService.installGame() with existing dir      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Download Game Files from GOG CDN                │
│              (Progress: 0% → 100%)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│         Progress Callback Updates Progress Bar               │
│         (Every few seconds during download)                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Extract/Install Downloaded Files                │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
        ┌─────────────┴──────────────┐
        │    Installation Result     │
        └─────────────┬──────────────┘
                      │
            ┌─────────┴─────────┐
            │                   │
         SUCCESS              FAILURE
            │                   │
            ▼                   ▼
┌──────────────────────┐  ┌──────────────────────┐
│ Set updating = false │  │ Set updating = false │
│ Hide update button   │  │ Keep update button   │
│ Hide progress bar    │  │ Hide progress bar    │
│ Toast: "Update       │  │ Toast: "Update       │
│  completed"          │  │  failed: [error]"    │
└──────────────────────┘  └──────────────────────┘
```

## User Cancellation Flow

```
┌─────────────────────────────────────────────────────────────┐
│              Update in Progress (Progress Bar)               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              User Clicks "CANCEL" Button                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│         InstallService.cancelInstallation() Called           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Stop Download/Installation                      │
│              Clean Up Partial Files                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Set updating = false                            │
│              Hide Progress Bar                               │
│              Show Update Button Again                        │
│              Toast: "Install cancelled"                      │
└─────────────────────────────────────────────────────────────┘
```

## State Diagram

```
                    ┌──────────────────┐
                    │   Not Installed  │
                    │                  │
                    │  [⬇ INSTALL]     │
                    └────────┬─────────┘
                             │
                             │ Install
                             ▼
                    ┌──────────────────┐
                    │   Installing     │
                    │                  │
                    │  [CANCEL]        │
                    │  [████░░░░] 50%  │
                    └────────┬─────────┘
                             │
                             │ Complete
                             ▼
    ┌────────────────────────────────────────────┐
    │           Installed (Latest)               │
    │                                            │
    │           [▶ PLAY]                         │
    └────────────┬───────────────────────────────┘
                 │
                 │ New Version Available
                 ▼
    ┌────────────────────────────────────────────┐
    │      Installed (Update Available)          │
    │                                            │
    │      [▶ PLAY]                              │
    │      [⬆ UPDATE]  ← Orange button           │
    └────────────┬───────────────────────────────┘
                 │
                 │ Click Update
                 ▼
    ┌────────────────────────────────────────────┐
    │           Updating                         │
    │                                            │
    │           [CANCEL]                         │
    │           [████████░░] 80%                 │
    └────────────┬───────────────────────────────┘
                 │
                 │ Complete
                 ▼
    ┌────────────────────────────────────────────┐
    │           Installed (Latest)               │
    │                                            │
    │           [▶ PLAY]                         │
    └────────────────────────────────────────────┘
```

## Component Interaction

```
┌─────────────────┐
│   Game Card     │
│   (UI Widget)   │
└────────┬────────┘
         │
         │ updateRequested(gameId)
         ▼
┌─────────────────┐
│  Library Page   │
│   (UI Logic)    │
└────────┬────────┘
         │
         │ updateGame(gameId)
         ▼
┌─────────────────┐         ┌──────────────────┐
│ Library Service │◄────────┤   GOG Client     │
│  (Game Info)    │         │  (API Calls)     │
└────────┬────────┘         └──────────────────┘
         │                           │
         │ getGame()                 │ fetchGameDownloads()
         │                           │
         ▼                           ▼
┌─────────────────┐         ┌──────────────────┐
│  Local Database │         │   GOG API        │
│  (Versions)     │         │  (Latest Info)   │
└─────────────────┘         └──────────────────┘
         │
         │ Compare Versions
         ▼
┌─────────────────┐
│ Install Service │
│  (Download)     │
└────────┬────────┘
         │
         │ installGame()
         │ Progress Callbacks
         ▼
┌─────────────────┐
│   Game Card     │
│  (Update UI)    │
└─────────────────┘
```

## Version Comparison Logic

```
┌─────────────────────────────────────────────────────────────┐
│              Get Installed Game Info                         │
│              installedVersion = "1.0.5"                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Fetch Latest Downloads                          │
│              Loop through all downloads                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Find Highest Version Number                     │
│              latestVersion = "1.0.8"                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              Compare Strings                                 │
│              "1.0.5" != "1.0.8"                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
                  ┌───┴────┐
                  │ Result │
                  └───┬────┘
                      │
            ┌─────────┴─────────┐
            │                   │
        Different             Same
            │                   │
            ▼                   ▼
    ┌──────────────┐    ┌──────────────┐
    │ Show Update  │    │ Hide Update  │
    │ Button       │    │ Button       │
    └──────────────┘    └──────────────┘
```

## Error Handling

```
┌─────────────────────────────────────────────────────────────┐
│                    Update Process                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
              ┌───────┴────────┐
              │  Error Occurs? │
              └───────┬────────┘
                      │
            ┌─────────┴─────────┐
            │                   │
           YES                 NO
            │                   │
            ▼                   ▼
┌──────────────────────┐  ┌──────────────────┐
│ Catch Error          │  │ Continue Normal  │
│ - Network failure    │  │ Flow             │
│ - Disk full          │  └──────────────────┘
│ - Permission denied  │
│ - Invalid download   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────┐
│              Stop Update Process                              │
│              Set updating = false                             │
│              Hide Progress Bar                                │
│              Keep Update Button Visible                       │
└──────────┬───────────────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────┐
│              Show Error Toast                                 │
│              "Update failed: [error message]"                 │
└──────────────────────────────────────────────────────────────┘
           │
           ▼
┌──────────────────────────────────────────────────────────────┐
│              User Can Try Again                               │
└──────────────────────────────────────────────────────────────┘
```
